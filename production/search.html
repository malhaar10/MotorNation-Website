<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search</title>
    <link rel="icon" type="image/png" href="/assets/miniLogo.avif">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9276332511991978"
     crossorigin="anonymous"></script>
    <!-- CSS stylesheets for page styling -->
    <link rel="stylesheet" href="page_header.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="search.css">

    <!-- Google Fonts configuration -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@200..700&display=swap" rel="stylesheet">

    <!-- External icon libraries -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.0/css/line.css">
    
    <!-- Search functionality script -->
    <script src="search-functionality.js"></script>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-VVD46ERHKP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-VVD46ERHKP');
</script>

<body>
    <!-- Header section with logo, navigation -->
    <section class="header">
        <!-- Logo container with home page link -->
        <div class="logo-container">
            <a href="index.html"><img src="assets/MotorNation.avif" alt="MotorNation Logo"></a>
        </div>

        <!-- Main navigation bar -->
        <nav id="navbar">
            <!-- Navigation links with hamburger menu support -->
            <div class="nav-links" id="navLinks">
                <i class="fa fa-times" onclick="hideMenu()"></i>
                <ul>
                    <li><a href="index.html">HOME</a></li>
                    <li><a href="reviews-page/reviews-home.html">REVIEWS</a></li>
                    <li><a href="news-template/news-home.html">NEWS</a></li>
                    <li><a href="article-page/article-home.html">ARTICLES</a></li>
                    <li><a href="electric/electric.html">ELECTRIC</a></li>
                    <li><a href="videos/video.html">VIDEOS</a></li>
                    <li class="search-bar-item">
                        <div class="nav-search-container">
                            <input type="text" id="nav-search-input" placeholder="Search..." class="nav-search-input">
                            <button onclick="performNavSearch()" class="nav-search-btn">
                                <i class="fa fa-search"></i>
                            </button>
                        </div>
                    </li>
                    <!-- <li><a href="content_input_panel/input_home.html">CONTENT_INPUT</a></li> -->
                </ul>
            </div>

            <i class="fa fa-bars" onclick="showMenu()"></i>
        </nav>
    </section>

    <!-- Search bar section with spacing -->
    <section class="search-section">
        <!-- Search functionality -->
        <div class="search-container">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search..">
            </div>
        </div>
    </section>

    <!-- Main content container with equal spacing -->
    <div class="main-content">

        <!-- Search Results Info -->
        <div class="search-info">
            <h1 id="searchTitle">Search Results</h1>
            <p id="searchQuery"></p>
        </div>

        <!-- Search Results Content -->
        <div id="results">
            <div class="no-results">Loading search results...</div>
        </div>
    </div>

    <section class="hr">
        <hr>
    </section>
    <!-- Contact and social media footer section -->
    <section class="contact-card">
        <img src="assets/MotorNation.avif" alt="MotorNation logo">
        <div class="social-icons">
            <a href="https://www.facebook.com/motornationofficial"><i class="fa fa-facebook"></i></a>
            <a href="https://x.com/MotorNation_?t=WVuJZhDNnad4yikXOYNUng&s=09"><i class="fa fa-twitter"></i></a>
            <a href="https://www.instagram.com/motornation_group?igsh=MWJjMGNma3AwMW45Ng=="><i class="fa fa-instagram"></i></a>
            <a href="https://www.youtube.com/channel/UC9HmzxcrnW3CGZVf0iPK6Eg"><i class="fa fa-youtube"></i></a>
        </div>
        <div class="contact-links">
            <a href="../about_us/about_us.html">About us</a>
            <a href="../contact_us/contact_us.html">Contact us</a>
            <a href="../TnC/tnc.html">Terms & Conditions</a>
            <a href="../careers/careers.html">Careers</a>
        </div>
    </section>

    <script>
        function redirectToPage(type, id, slug = null) {
            if (type === 'review') {
                window.location.href = `reviews-page/review.html?id=${id}`;
            } else if (type === 'news') {
                window.location.href = `news-template/news-page-template.html?id=${id}`;
            }
        }

        window.addEventListener('load', async () => {
            const params = new URLSearchParams(window.location.search);
            const tag = params.get('tag');

            const container = document.getElementById('results');
            const searchQuery = document.getElementById('searchQuery');

            if (!tag) {
                container.innerHTML = '<div class="results-container"><div class="no-results">No search term provided.</div></div>';
                return;
            }

            searchQuery.textContent = `Showing results for: "${tag}"`;

            try {
                const fullUrl = `https://motornation-336079007565.us-central1.run.app/api/search?tag=${encodeURIComponent(tag)}`;
                console.log("Fetching from:", fullUrl);

                const res = await fetch(fullUrl);
                console.log("Status:", res.status);

                if (!res.ok) {
                    const errText = await res.text();
                    console.error("Error body:", errText);
                    throw new Error("Request failed");
                }

                const data = await res.json();
                console.log("Fetched data:", data);

                if (data.reviews.length === 0 && data.news.length === 0) {
                    container.innerHTML = `<div class="results-container"><div class="no-results">No results found for: "${tag}"</div></div>`;
                    return;
                }

                let html = '';

                // Reviews section
                if (data.reviews.length > 0) {
                    html += '<section class="latest-news search-results-section">';
                    html += '<div class="results-container">';
                    html += '<div class="section-title">Reviews (' + data.reviews.length + ')</div>';
                    html += '<div class="container">';
                    html += '<div class="blog-section">';
                    html += '<div class="cards">';

                    data.reviews.forEach(r => {
                        // Use first image from GCS if available, otherwise fallback to placeholder
                        const imageUrl = (r.images && r.images.length > 0) 
                            ? r.images[0] 
                            : "images/2025-crv/63_2024HondaCRVEX-L.avif";
                            
                        html += `
                            <div class="card" onclick="redirectToPage('review', '${r.id}', '${r.slug || ''}')" style="cursor: pointer;">
                                <div class="image-section">
                                    <img src="${imageUrl}" alt="${r.car_name}" loading="lazy">
                                </div>
                                <div class="content">
                                    <p>REVIEW</p>
                                    <h3>${r.car_name}</h3>
                                    <h5>${r.model_year} | ${r.tag}${r.tag2 ? ', ' + r.tag2 : ''}</h5>
                                    <hr>
                                </div>
                            </div>
                        `;
                    });

                    html += '</div></div></div></div></section>';
                }

                // Separator if both sections exist
                if (data.reviews.length > 0 && data.news.length > 0) {
                    html += '<section class="hr"><hr></section>';
                }

                // News section
                if (data.news.length > 0) {
                    html += '<section class="latest-news search-results-section">';
                    html += '<div class="results-container">';
                    html += '<div class="section-title">News (' + data.news.length + ')</div>';
                    html += '<div class="container">';
                    html += '<div class="blog-section">';
                    html += '<div class="cards">';

                    data.news.forEach(n => {
                        const newsDate = new Date(n.date).toLocaleDateString('en-GB', {
                            day: 'numeric',
                            month: 'short',
                            year: 'numeric'
                        });

                        // Use first image from GCS if available, otherwise fallback to placeholder
                        const imageUrl = (n.images && n.images.length > 0) 
                            ? n.images[0] 
                            : "images/2025-crv/29_2024HondaCRVEX-L.avif";

                        html += `
                            <div class="card" onclick="redirectToPage('news', '${n.id}', '${n.slug || ''}')" style="cursor: pointer;">
                                <div class="image-section">
                                    <img src="${imageUrl}" alt="${n.news_title}" loading="lazy">
                                </div>
                                <div class="content">
                                    <p>${n.tag.toUpperCase()}</p>
                                    <h3>${n.news_title}</h3>
                                    <h5>${newsDate} | ${n.tag}${n.tag2 ? ', ' + n.tag2 : ''}</h5>
                                    <hr>
                                </div>
                            </div>
                        `;
                    });

                    html += '</div></div></div></div></section>';
                }

                container.innerHTML = html;

            } catch (err) {
                console.error("Fetch failed:", err);
                container.innerHTML = '<div class="results-container"><div class="no-results">Error fetching search results: ' + err.message + '</div></div>';
            }
        });

        // Search functionality for the search box in header
        document.getElementById('searchInput').addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                const tag = this.value.trim();
                if (!tag) return;
                window.location.href = `search.html?tag=${encodeURIComponent(tag)}`;
            }
        });

        // Navigation search bar functionality
        const navSearchInput = document.getElementById('nav-search-input');
        if (navSearchInput) {
            navSearchInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    performNavSearch();
                }
            });
        }

        // Function to perform navigation search
        function performNavSearch() {
            const searchQuery = document.getElementById('nav-search-input').value.trim();
            if (searchQuery) {
                // Redirect to search page with tag parameter (matches backend API)
                window.location.href = `search.html?tag=${encodeURIComponent(searchQuery)}`;
            }
        }

        // Mobile navigation menu toggle functionality
        var navLinks = document.getElementById("navLinks");

        function showMenu() {
            navLinks.style.right = "0";
        }

        function hideMenu() {
            navLinks.style.right = "-200px";
        }
    </script>

</body>

</html>
